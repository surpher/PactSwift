#!/usr/bin/env bash

set -euo pipefail

# Scirpt that prepares PactSwift.xcframework

# Properties

TMP_DIR="./.tmp/build-xcframework"
PRODUCT_NAME="PactSwift"

# Setup

echo "üëÆ Looking for ${PRODUCT_NAME}.xcodeproj"
if [ ! -d "${PRODUCT_NAME}.xcodeproj" ]; then
    echo "üö® Run this in the same folder as \"${PRODUCT_NAME}.xcodeproj\"."
    exit 1
fi

echo "üßπ Removing existing XCFramework"
rm -fr ./PactSwift.xcframework
echo "üëç  Removed existing XCFramework"

echo "‚ÑπÔ∏è  Preparing ${TMP_DIR} folder"
mkdir -p $TMP_DIR
rm -fr $TMP_DIR

###################
# iOS - Device
###################

echo "üèó  Building for iOS..."
xcodebuild archive \
    -sdk iphoneos IPHONEOS_DEPLOYMENT_TARGET=12.0 \
    -arch arm64 \
    -scheme "${PRODUCT_NAME}-iOS" \
    -archivePath "${TMP_DIR}/iphoneos/${PRODUCT_NAME}.xcarchive" \
    BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
    SKIP_INSTALL=NO | xcbeautify
echo "üëç  Framework for arm64 (iOS device) built"

###################
# iOS - Simulator
###################

echo "üèó  Building for iOS Simulator..."
xcodebuild archive \
    -sdk iphonesimulator IPHONEOS_DEPLOYMENT_TARGET=12.0 \
    -arch x86_64 \
    -scheme "${PRODUCT_NAME}-iOS" \
    -archivePath "${TMP_DIR}/iphonesimulator/${PRODUCT_NAME}.xcarchive" \
    BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
    SKIP_INSTALL=NO | xcbeautify
echo "üëç  Framework for iOS Simulator built for x86_64 architecture"

# TODO: PactSwiftMockServer is still missing the arm64-apple-ios-simulator support - rust triple still in Tier3
# xcodebuild archive \
#     -sdk iphonesimulator IPHONEOS_DEPLOYMENT_TARGET=12.0 \
#     -arch x86_64 -arch arm64 \ # <-- ADDED arm64 architecture for simulator --- ###
#     -scheme "${PRODUCT_NAME}-iOS" \
#     -archivePath "${TMP_DIR}/iphonesimulator/${PRODUCT_NAME}.xcarchive" \
#     BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
#     SKIP_INSTALL=NO | xcbeautify
# echo "üëç  Framework for iOS Simulator built for x86_64 architecture"

###################
# macOS
###################

echo "üèó  Building for macOS..."
xcodebuild archive \
    -sdk macosx MACOSX_DEPLOYMENT_TARGET=10.12 \
    -arch x86_64 -arch arm64 \
    -scheme "${PRODUCT_NAME}-macOS" \
    -archivePath "${TMP_DIR}/macos/${PRODUCT_NAME}.xcarchive" \
    BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
    SKIP_INSTALL=NO | xcbeautify
echo "üëç  Framework for macOS built for x86_64 and arm64 architectures"

###################
# XCFramework
###################

echo "üèó  Building XCFramework..."
xcodebuild -create-xcframework -output ./$PRODUCT_NAME.xcframework \
    -framework $TMP_DIR/iphoneos/$PRODUCT_NAME.xcarchive/Products/Library/Frameworks/$PRODUCT_NAME.framework \
    -framework $TMP_DIR/iphonesimulator/$PRODUCT_NAME.xcarchive/Products/Library/Frameworks/$PRODUCT_NAME.framework \
    -framework $TMP_DIR/macos/$PRODUCT_NAME.xcarchive/Products/Library/Frameworks/$PRODUCT_NAME.framework

# Cleanup
echo "üßπ  Removing $TMP_DIR folder..."
rm -fr $TMP_DIR

echo "üëç Done!"
